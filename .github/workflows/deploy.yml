name: Deploy to Hostinger

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via FTP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List local files
        run: find . -not -path './.git/*' -not -path './.github/*' | sort

      - name: Upload via Python FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          python3 << 'PYEOF'
          import ftplib, ssl, os

          EXCLUDE = {'.git', '.github', 'README.md', 'LICENSE', '.gitignore'}
          LOCAL_DIR = '.'
          REMOTE_DIR = '/public_html'

          ctx = ssl.create_default_context()
          ctx.check_hostname = False
          ctx.verify_mode = ssl.CERT_NONE

          print("Connecting to FTP...")
          ftp = ftplib.FTP_TLS(context=ctx)
          ftp.connect(os.environ['FTP_HOST'], 21, timeout=30)
          ftp.login(os.environ['FTP_USER'], os.environ['FTP_PASS'])
          ftp.prot_p()
          print("Connected OK")

          print(f"\n=== Remote root ===")
          ftp.retrlines('LIST')

          print(f"\n=== Remote {REMOTE_DIR} ===")
          try:
              ftp.cwd(REMOTE_DIR)
              ftp.retrlines('LIST')
          except Exception as e:
              print(f"Error accessing {REMOTE_DIR}: {e}")
              print("Creating directory...")
              ftp.mkd(REMOTE_DIR)
              ftp.cwd(REMOTE_DIR)

          print(f"\nCurrent remote dir: {ftp.pwd()}")

          def upload_dir(local_path, remote_path):
              for item in sorted(os.listdir(local_path)):
                  if item in EXCLUDE:
                      continue
                  local_item = os.path.join(local_path, item)
                  if os.path.isfile(local_item):
                      size = os.path.getsize(local_item)
                      print(f"  Uploading: {local_item} ({size} bytes) -> {remote_path}/{item}")
                      with open(local_item, 'rb') as f:
                          ftp.storbinary(f'STOR {item}', f)
                      print(f"  OK: {item}")
                  elif os.path.isdir(local_item):
                      print(f"  Creating dir: {item}/")
                      try:
                          ftp.mkd(item)
                      except:
                          pass
                      ftp.cwd(item)
                      upload_dir(local_item, f"{remote_path}/{item}")
                      ftp.cwd('..')

          print("\n=== Uploading files ===")
          upload_dir(LOCAL_DIR, REMOTE_DIR)

          print(f"\n=== Verifying {REMOTE_DIR} after upload ===")
          ftp.cwd(REMOTE_DIR)
          ftp.retrlines('LIST')

          ftp.quit()
          print("\nDone!")
          PYEOF
